<!doctype html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Multi Tenancy Â· NoBrainer</title>
  <link rel="stylesheet" href="/css/screen.css" />
</head>

<body class="wrap">
  <header>
  <div class="grid">
    <div class="unit one-fifth"> </div>
    <div class="unit four-fifths">
      <h1> <a href="/"> <span>NoBrainer</span> </a> </h1>
      <h3>A Ruby ORM for RethinkDB</h3>
    </div>
  </div>

<!-- put back when we do it properly for mobiles -->
<!-- <a href="https://github.com/nviennot/nobrainer"><img style="position: absolute; top: 0; right:0; border: 0; width: 149px; height: 149px;" src="/img/forkme.png" alt="Fork me on GitHub"></a> -->

</header>


  <section class="docs">
  <div class="grid">

    <div class="unit one-fifth">
  <aside>
    <h4>Getting Started</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/introduction/">Introduction</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/differences_from_other_orms/">Differences from other ORMs</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/configuration/">Configuration</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Models</h4> 

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/models/">Models</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/fields/">Fields</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/types/">Types</a></li>
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/timestamps/">Timestamps</a></li>
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/serialization/">Serialization</a></li>
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/persistence/">Persistence</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/callbacks/">Callbacks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/validations/">Validations</a></li>
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/dirty_tracking/">Dirty Tracking</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
      <li class=""><a href="/docs/associations/">Associations</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/querying/">Querying</a></li>
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/scopes/">Scopes</a></li>
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/eager_loading/">Eager Loading</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Advanced Topics</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/caching/">Caching</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/rql_layer/">RQL Layer</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/atomic_ops/">Atomic Operations</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/distributed_locks/">Distributed Locks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/indexes/">Indexes</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/management/">Management</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class="current"><a href="/docs/multi_tenancy/">Multi Tenancy</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Miscellaneous</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/roadmap/">Roadmap</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/changelog/">Changelog</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
      <li class=""><a href="/docs/3rd_party_integration/">3rd-party Integration</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/communication/">Communication</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/faq/">FAQ</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/credits/">Credits</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

  </aside>
</div>


    <div class="like-buttons">
      <div class="github">
        <iframe src="/github-btn.html?user=nviennot&repo=nobrainer&type=watch&count=true"
          allowtransparency="true" frameborder="0" scrolling="0" width="100" height="20"></iframe>
      </div>

      <div class="twitter">
        <a href="https://twitter.com/nviennot" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @nviennot</a>
       <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
      </div>

    </div>

    <div class="unit four-fifths">
      <article>
        <h1>Multi Tenancy</h1>
        
<p>NoBrainer supports multi tenancy features. These features are for advanced users that understand the behavior of NoBrainer, especially the <a href="/docs/rql_layer">RQL layer</a>, and the <a href="/docs/caching">caching behavior</a>. NoBrainer provides two different ways to perform multi tenancy:</p>

<ol>
<li>Using a <code>with_database</code> block.</li>

<li>Using a <code>store_in</code> model declaration.</li>
</ol>

<h2 id="changing_databases_at_the_connection_level">Changing databases at the connection level</h2>

<p>You may use <code>NoBrainer.with_database</code> to change the default database to use on the connection.</p>
<div class='highlight'><pre><code class='ruby'><span class='no'>NoBrainer</span><span class='o'>.</span><span class='n'>with_database</span><span class='p'>(</span><span class='s1'>&#39;client1&#39;</span><span class='p'>)</span> <span class='k'>do</span>
  <span class='no'>Project</span><span class='o'>.</span><span class='n'>each</span> <span class='p'>{</span> <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span> <span class='p'>}</span>
<span class='k'>end</span>
</code></pre></div>
<p><code>NoBrainer.with_database(name)</code> is an alias for <code>NoBrainer.with(:db =&gt; name)</code>, which can be seen as a thread safe version of the <a href="http://www.rethinkdb.com/api/ruby/#use"><code>r.use()</code></a>. This means that all the rules of <code>NoBrainer.with</code> applies. Specifically, you should never leak a criteria outside a <code>with_database()</code> block. For example:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>criteria</span> <span class='o'>=</span> <span class='no'>NoBrainer</span><span class='o'>.</span><span class='n'>with_database</span><span class='p'>(</span><span class='s1'>&#39;client1&#39;</span><span class='p'>)</span> <span class='p'>{</span> <span class='no'>Project</span><span class='o'>.</span><span class='n'>all</span> <span class='p'>}</span>
<span class='n'>criteria</span><span class='o'>.</span><span class='n'>first</span> <span class='c1'># Will not read the client1 projects.</span>
</code></pre></div>
<p>The <code>with_database()</code> clause takes effect only when a RQL query is executed. Criteria are not aware of such multi tenancy features, and will behave as expected with respect to caching. For example:</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># Creating a criteria instance.</span>
<span class='n'>criteria</span> <span class='o'>=</span> <span class='no'>Project</span><span class='o'>.</span><span class='n'>all</span>

<span class='c1'># The following each query caches the documents on criteria.</span>
<span class='no'>NoBrainer</span><span class='o'>.</span><span class='n'>with_database</span><span class='p'>(</span><span class='s1'>&#39;client1&#39;</span><span class='p'>)</span> <span class='p'>{</span> <span class='n'>criteria</span><span class='o'>.</span><span class='n'>each</span> <span class='p'>{</span> <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span> <span class='p'>}</span> <span class='p'>}</span>

<span class='c1'># The following does not returns clients2 projects, but client1 projects</span>
<span class='c1'># because of caching side effects.</span>
<span class='no'>NoBrainer</span><span class='o'>.</span><span class='n'>with_database</span><span class='p'>(</span><span class='s1'>&#39;client2&#39;</span><span class='p'>)</span> <span class='p'>{</span> <span class='n'>criteria</span><span class='o'>.</span><span class='n'>each</span> <span class='p'>{</span> <span class='o'>.</span><span class='n'>.</span><span class='o'>.</span> <span class='p'>}</span> <span class='p'>}</span> 
</code></pre></div>
<p>Note that <code>with_database()</code> can be nested, and is thread safe.</p>

<p><strong>TL;DR</strong> do not leak criteria out of <code>with_database()</code> blocks.</p>

<p>Typically, <code>with_database()</code> blocks are implemented as around filters on controllers, or rack middlewares.</p>

<h2 id="model_specific_database_behavior">Model specific database behavior</h2>

<p>With NoBrainer you may specify which Model gets stored where with the <code>store_in</code> declaration. For example, to store the User model in <code>some_table</code> in <code>some_db</code>:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>User</span>
  <span class='n'>store_in</span> <span class='ss'>:database</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;some_db&#39;</span><span class='p'>,</span> <span class='ss'>:table</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;some_table&#39;</span>
<span class='k'>end</span>
</code></pre></div>
<p>It is much more interesting to use lazily evaluated lambdas. For example:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>User</span>
  <span class='n'>store_in</span> <span class='ss'>:database</span> <span class='o'>=&gt;</span> <span class='o'>-&gt;</span><span class='p'>{</span> <span class='s2'>&quot;</span><span class='si'>#{</span><span class='no'>Thread</span><span class='o'>.</span><span class='n'>current</span><span class='o'>[</span><span class='ss'>:client</span><span class='o'>]</span><span class='si'>}</span><span class='s2'>&quot;</span> <span class='p'>}</span>
<span class='k'>end</span>
</code></pre></div>
<p>Now, the User database is defined dynamically, depending on the content of <code>Thread.current[:client]</code>. We could have also defined the table name in the same way.</p>

<p>The lambda is evaluated when compiling the criteria down to a RQL expression. Calling <code>User.rql_table</code> or <code>User.all.to_rql</code> will evaluate the lambda. This is because instead of using a connection option, the database and table names are directly embedded in the RQL query using the <a href="http://www.rethinkdb.com/api/ruby/#db"><code>r.db()</code></a> and <a href="http://www.rethinkdb.com/api/ruby/#table"><code>r.table()</code></a> commands. This allow the power to hit multiple databases within the same query by, for example, using joins. The following shows an example of using the previous <code>store_in</code> declaration:</p>
<div class='highlight'><pre><code class='ruby'><span class='no'>Thread</span><span class='o'>.</span><span class='n'>current</span><span class='o'>[</span><span class='ss'>:client</span><span class='o'>]</span> <span class='o'>=</span> <span class='s1'>&#39;client1&#39;</span>
<span class='no'>User</span><span class='o'>.</span><span class='n'>rql_table</span> <span class='c1'># r.db(&#39;client1&#39;).table(&#39;users&#39;)</span>
<span class='no'>User</span><span class='o'>.</span><span class='n'>all</span><span class='o'>.</span><span class='n'>count</span> <span class='c1'># NoBrainer.run { r.db(&#39;client1&#39;).table(&#39;users&#39;).count }</span>
</code></pre></div>
<p>If you mix <code>NoBrainer.with_database</code> and <code>store_in</code> declaration, the latter has precedence on the former as you would expect. As a word of warning, please understand what you are doing, things can get hairy very quickly.</p>

<p>If you want to test your lambdas, you can read the used database and table names with <code>Model.database_name</code> and <code>Model.table_name</code>. If <code>Model.database_name</code> returns <code>nil</code>, the <code>r.db()</code> command will not be inserted in generated RQL queries and the default connection database name will be used when running the RQL query as explained earlier.</p>

<h2 id="managing_databases">Managing Databases</h2>

<p>NoBrainer does not automatically create indexes when auto creating a database or table. To create the indexes on a custom database, you may use the following:</p>
<div class='highlight'><pre><code class='ruby'><span class='no'>NoBrainer</span><span class='o'>.</span><span class='n'>with_database</span><span class='p'>(</span><span class='s1'>&#39;db_name&#39;</span><span class='p'>)</span> <span class='p'>{</span> <span class='no'>NoBrainer</span><span class='o'>.</span><span class='n'>sync_indexes</span> <span class='p'>}</span>
</code></pre></div>
<p>Make sure all your models are loaded before calling <code>sync_indexes</code> if you are not using Rails.</p>

        <hr />
        <div class="section-nav">
  <div class="left align-right">
    
      <a href="/docs/management/" class="prev">
        Back
      </a>
    
  </div>
  <div class="right align-left">
    
      <a href="/docs/roadmap/" class="next">
        Next
      </a>
    
  </div>
  <div class="clear"></div>
</div>

      </article>
    </div>

    <div class="clear"></div>

  </div>
</section>


  <footer>
  <div class="grid">
    <div class="unit whole">
      NoBrainer is written and maintained by
      <a href="https://twitter.com/nviennot">Nicolas Viennot</a>.
    </div>
  </div>
</footer>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46753546-1', 'nobrainer.io');
  ga('send', 'pageview');
</script>

</body>
</html>
